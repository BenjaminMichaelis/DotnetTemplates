name: Update Template EditorConfig

on:
  push:
    branches: [ main ]
    paths:
      - '.editorconfig'
  workflow_dispatch:

defaults:
  run:
    shell: pwsh

permissions:
  contents: write
  pull-requests: write

jobs:
  update-template-editorconfig:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Check for existing PR
        id: check-pr
        run: |
          $existingPR = gh pr list --head "update-template-editorconfig" --state open --json number,title | ConvertFrom-Json
          if ($existingPR.Count -gt 0) {
            Write-Host "Found existing PR #$($existingPR[0].number): $($existingPR[0].title)"
            "has_existing_pr=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "pr_number=$($existingPR[0].number)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            Write-Host "No existing PR found"
            "has_existing_pr=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create or update branch
        run: |
          $branchName = "update-template-editorconfig"
          
          # Check if branch exists
          $branchExists = git branch -r --list "origin/$branchName"
          if ($branchExists) {
            Write-Host "Branch $branchName exists, checking it out"
            git fetch origin $branchName
            git checkout $branchName
            git merge main --no-edit
          } else {
            Write-Host "Creating new branch $branchName"
            git checkout -b $branchName
          }

      - name: Run EditorConfig update script
        id: update-script
        run: |
          Write-Host "Running CopyEditorConfigToTemplates.ps1..."
          ./CopyEditorConfigToTemplates.ps1
          
          # Check if there are any changes
          $changes = git status --porcelain
          if ($changes) {
            Write-Host "Changes detected:"
            Write-Host $changes
            "has_changes=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            
            # Get the list of changed template directories for the PR description
            $changedTemplates = @()
            foreach ($line in $changes -split "`n") {
              if ($line -match "templates/([^/]+/[^/]+)/\.editorconfig") {
                $changedTemplates += $matches[1]
              }
            }
            $templateList = $changedTemplates -join ", "
            "changed_templates=$templateList" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            Write-Host "No changes detected"
            "has_changes=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }

      - name: Commit and push changes
        if: steps.update-script.outputs.has_changes == 'true'
        run: |
          git add .
          git commit -m "Update template .editorconfig files to match root configuration

          Automatically generated by update-template-editorconfig workflow.
          Updated templates: ${{ steps.update-script.outputs.changed_templates }}"
          git push origin update-template-editorconfig

      - name: Create Pull Request
        if: steps.update-script.outputs.has_changes == 'true' && steps.check-pr.outputs.has_existing_pr == 'false'
        run: |
          $prBody = @"
          This PR automatically updates template `.editorconfig` files to match the root repository configuration.
          
          ## Changes Made
          - Updated `.editorconfig` files in the following templates: **${{ steps.update-script.outputs.changed_templates }}**
          - Templates with existing customizations were preserved and backed up for manual review
          
          ## Automation Details
          This PR was automatically created by the `update-template-editorconfig` workflow when changes were detected in the root `.editorconfig` file.
          
          Please review the changes to ensure:
          1. Templates without customizations received the updated configuration
          2. Templates with customizations were handled appropriately
          3. Any backup files created need manual review and merging
          
          Generated by: ${{ github.workflow }} workflow
          Triggered by: ${{ github.event_name }} on ${{ github.ref }}
          "@
          
          gh pr create \
            --title "ðŸ¤– Update template .editorconfig files" \
            --body "$prBody" \
            --head "update-template-editorconfig" \
            --base "main" \
            --label "automation" \
            --label "editorconfig"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update existing Pull Request
        if: steps.update-script.outputs.has_changes == 'true' && steps.check-pr.outputs.has_existing_pr == 'true'
        run: |
          Write-Host "Updating existing PR #${{ steps.check-pr.outputs.pr_number }}"
          $prBody = @"
          This PR automatically updates template `.editorconfig` files to match the root repository configuration.
          
          ## Changes Made
          - Updated `.editorconfig` files in the following templates: **${{ steps.update-script.outputs.changed_templates }}**
          - Templates with existing customizations were preserved and backed up for manual review
          
          ## Automation Details
          This PR was automatically updated by the `update-template-editorconfig` workflow when changes were detected in the root `.editorconfig` file.
          
          Please review the changes to ensure:
          1. Templates without customizations received the updated configuration
          2. Templates with customizations were handled appropriately
          3. Any backup files created need manual review and merging
          
          Generated by: ${{ github.workflow }} workflow
          Triggered by: ${{ github.event_name }} on ${{ github.ref }}
          Last updated: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
          "@
          
          gh pr edit ${{ steps.check-pr.outputs.pr_number }} --body "$prBody"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: No changes summary
        if: steps.update-script.outputs.has_changes == 'false'
        run: |
          Write-Host "âœ… No template .editorconfig updates needed"
          Write-Host "All templates are already in sync with the root .editorconfig"